<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test Sayfasƒ± - Charger Station</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        /* ESP32 Status Bar */
        .status-bar {
            background: #1a1a1a;
            color: white;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 8px;
            border-bottom: 3px solid #333;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .status-bar-title {
            font-weight: bold;
            font-size: 0.85em;
            color: #888;
            margin-right: 8px;
            white-space: nowrap;
        }

        .status-item {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
            background: #2a2a2a;
            border: 1px solid #444;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .status-item.changed {
            animation: highlight 0.6s ease;
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        @keyframes highlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background: #444; }
            100% { transform: scale(1); }
        }

        .status-label {
            color: #aaa;
            font-size: 0.75em;
        }

        .status-value {
            font-weight: bold;
            color: white;
            font-size: 0.85em;
        }

        /* STATE renkleri (ESP32 kodundan) */
        .status-state-1 { background: #ffffff; color: #000; border-color: #ccc; } /* IDLE - Beyaz */
        .status-state-2 { background: rgb(0, 150, 150); color: white; } /* CABLE_DETECT - Turkuaz */
        .status-state-3 { background: rgb(10, 10, 255); color: white; } /* EV_CONNECTED - Mavi */
        .status-state-4 { background: rgb(10, 10, 255); color: white; } /* SARJA_HAZIR - Mavi */
        .status-state-5 { background: #4CAF50; color: white; } /* SARJ_BASLADI - Ye≈üil */
        .status-state-6 { background: rgb(255, 250, 0); color: #000; } /* SARJ_DURAKLATILDI - Sarƒ± */
        .status-state-7 { background: rgb(255, 20, 70); color: white; } /* SARJ_BITIR - Lila */
        .status-state-8 { background: #F44336; color: white; } /* FAULT_HARD - Kƒ±rmƒ±zƒ± */

        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
            flex-shrink: 0;
        }

        .status-indicator.offline {
            background: #F44336;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-last-update {
            font-size: 0.7em;
            color: #888;
            margin-left: auto;
            white-space: nowrap;
        }

        .content {
            padding: 30px;
        }

        @media (max-width: 768px) {
            .status-bar {
                padding: 8px 10px;
                gap: 6px;
            }
            .status-item {
                padding: 3px 6px;
                font-size: 0.75em;
            }
            .status-bar-title {
                width: 100%;
                margin-bottom: 4px;
            }
            .status-last-update {
                width: 100%;
                margin-left: 0;
                margin-top: 4px;
                text-align: center;
            }
        }

        .endpoint-group {
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background: #f9f9f9;
        }

        .endpoint-group h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .endpoint {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .endpoint-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .method {
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.85em;
            color: white;
        }

        .method.get { background: #4CAF50; }
        .method.post { background: #2196F3; }
        .method.put { background: #FF9800; }
        .method.delete { background: #F44336; }

        .endpoint-path {
            font-family: 'Courier New', monospace;
            font-size: 1em;
            color: #333;
            font-weight: 500;
        }

        .endpoint-description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .request-body {
            margin-bottom: 15px;
        }

        .request-body label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 0.9em;
        }

        .request-body input,
        .request-body textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .request-body textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .response-section {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            display: none;
        }

        .response-section.show {
            display: block;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .response-header h3 {
            color: #333;
            font-size: 1em;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.85em;
        }

        .status-badge.success { background: #4CAF50; color: white; }
        .status-badge.error { background: #F44336; color: white; }
        .status-badge.info { background: #2196F3; color: white; }

        .request-display,
        .response-display {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 10px;
        }

        .curl-preview {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .curl-preview label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 0.9em;
        }

        .curl-preview textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            min-height: 80px;
            resize: vertical;
            background: #2d2d2d;
            color: #f8f8f2;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .section-title {
            color: #667eea;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 15px;
            margin-bottom: 5px;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box p {
            color: #1976d2;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîå Charger Station API Test Sayfasƒ±</h1>
            <p>API endpoint'lerini test etmek i√ßin kullanƒ±n</p>
        </div>
        
        <!-- ESP32 Real-Time Status Bar -->
        <div class="status-bar" id="statusBar">
            <span class="status-bar-title">ESP32 Status:</span>
            <div class="status-item" id="statusIndicator">
                <span class="status-indicator" id="statusDot"></span>
                <span class="status-label">Baƒülantƒ±</span>
            </div>
            <div class="status-item status-state-1" id="statusState">
                <span class="status-label">STATE:</span>
                <span class="status-value" id="stateValue">-</span>
            </div>
            <div class="status-item" id="statusCP">
                <span class="status-label">CP:</span>
                <span class="status-value" id="cpValue">-</span>
            </div>
            <div class="status-item" id="statusPP">
                <span class="status-label">PP:</span>
                <span class="status-value" id="ppValue">-</span>
            </div>
            <div class="status-item" id="statusRL">
                <span class="status-label">RL:</span>
                <span class="status-value" id="rlValue">-</span>
            </div>
            <div class="status-item" id="statusLOCK">
                <span class="status-label">LOCK:</span>
                <span class="status-value" id="lockValue">-</span>
            </div>
            <div class="status-item" id="statusMAX">
                <span class="status-label">MAX:</span>
                <span class="status-value" id="maxValue">-</span>
                <span style="font-size: 0.7em; margin-left: 2px;">A</span>
            </div>
            <div class="status-item" id="statusAUTH">
                <span class="status-label">AUTH:</span>
                <span class="status-value" id="authValue">-</span>
            </div>
            <div class="status-last-update" id="lastUpdate">Son g√ºncelleme: -</div>
        </div>

        <div class="content">
            <div class="info-box">
                <p>
                    <strong>‚ÑπÔ∏è Bilgi:</strong> Bu sayfa test ama√ßlƒ±dƒ±r. T√ºm istekler otomatik olarak API key ile g√∂nderilir. 
                    Request ve Response body'leri a≈üaƒüƒ±da g√∂r√ºnt√ºlenir.
                </p>
            </div>

            <!-- Health Check -->
            <div class="endpoint-group">
                <h2>System Endpoints</h2>
                
                <div class="endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="endpoint-path">/api/health</span>
                    </div>
                    <div class="endpoint-description">Sistem saƒülƒ±k kontrol√º</div>
                    <button class="btn" onclick="testEndpoint('GET', '/api/health', null)">Test Et</button>
                    <div class="response-section" id="response-/api/health"></div>
                </div>

                <div class="endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="endpoint-path">/api/status</span>
                    </div>
                    <div class="endpoint-description">ESP32 durum bilgisi</div>
                    <button class="btn" onclick="testEndpoint('GET', '/api/status', null)">Test Et</button>
                    <div class="response-section" id="response-/api/status"></div>
                </div>

                <div class="endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="endpoint-path">/api/current/available</span>
                    </div>
                    <div class="endpoint-description">Kullanƒ±labilir akƒ±m aralƒ±ƒüƒ±</div>
                    <button class="btn" onclick="testEndpoint('GET', '/api/current/available', null)">Test Et</button>
                    <div class="response-section" id="response-/api/current/available"></div>
                </div>

                <div class="endpoint">
                    <div class="endpoint-header">
                        <span class="method get">GET</span>
                        <span class="endpoint-path">/api/station/info</span>
                    </div>
                    <div class="endpoint-description">ƒ∞stasyon bilgileri</div>
                    <button class="btn" onclick="testEndpoint('GET', '/api/station/info', null)">Test Et</button>
                    <div class="response-section" id="response-/api/station/info"></div>
                </div>
            </div>

            <!-- Charge Control -->
            <div class="endpoint-group">
                <h2>Charge Control (Authentication Required)</h2>
                
                <div class="endpoint">
                    <div class="endpoint-header">
                        <span class="method post">POST</span>
                        <span class="endpoint-path">/api/charge/start</span>
                    </div>
                    <div class="endpoint-description">≈ûarj ba≈ülatma</div>
                    <div class="request-body">
                        <label>Request Body (JSON):</label>
                        <textarea id="body-/api/charge/start" placeholder='{}' oninput="updateCurlPreviewDebounced('POST', '/api/charge/start', 'body-/api/charge/start', 'curl-/api/charge/start')">{"test": true}</textarea>
                    </div>
                    <div class="curl-preview">
                        <label>üíª cURL Command (Edit edilebilir):</label>
                        <textarea id="curl-/api/charge/start"></textarea>
                    </div>
                    <button class="btn" onclick="testEndpoint('POST', '/api/charge/start', 'body-/api/charge/start')">Test Et</button>
                    <div class="response-section" id="response-/api/charge/start"></div>
                </div>

                <div class="endpoint">
                    <div class="endpoint-header">
                        <span class="method post">POST</span>
                        <span class="endpoint-path">/api/charge/stop</span>
                    </div>
                    <div class="endpoint-description">≈ûarj durdurma</div>
                    <div class="request-body">
                        <label>Request Body (JSON):</label>
                        <textarea id="body-/api/charge/stop" placeholder='{}' oninput="updateCurlPreviewDebounced('POST', '/api/charge/stop', 'body-/api/charge/stop', 'curl-/api/charge/stop')">{"test": true}</textarea>
                    </div>
                    <div class="curl-preview">
                        <label>üíª cURL Command (Edit edilebilir):</label>
                        <textarea id="curl-/api/charge/stop"></textarea>
                    </div>
                    <button class="btn" onclick="testEndpoint('POST', '/api/charge/stop', 'body-/api/charge/stop')">Test Et</button>
                    <div class="response-section" id="response-/api/charge/stop"></div>
                </div>
            </div>

            <!-- Current Control -->
            <div class="endpoint-group">
                <h2>Current Control (Authentication Required)</h2>
                
                <div class="endpoint">
                    <div class="endpoint-header">
                        <span class="method post">POST</span>
                        <span class="endpoint-path">/api/maxcurrent</span>
                    </div>
                    <div class="endpoint-description">Maksimum akƒ±m ayarlama (6-32A)</div>
                    <div class="request-body">
                        <label>Amperage:</label>
                        <input type="number" id="body-/api/maxcurrent" placeholder="16" value="16" min="6" max="32" oninput="updateCurlPreviewDebounced('POST', '/api/maxcurrent', 'body-/api/maxcurrent', 'curl-/api/maxcurrent', true)">
                    </div>
                    <div class="curl-preview">
                        <label>üíª cURL Command (Edit edilebilir):</label>
                        <textarea id="curl-/api/maxcurrent"></textarea>
                    </div>
                    <button class="btn" onclick="testEndpoint('POST', '/api/maxcurrent', 'body-/api/maxcurrent', true)">Test Et</button>
                    <div class="response-section" id="response-/api/maxcurrent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API base URL - Ngrok veya local
        const API_BASE_URL = window.location.origin;
        let cachedApiKey = null;

        // Debounce timer for curl preview updates
        let curlPreviewTimeouts = {};

        // ESP32 Status Tracking
        let lastStatusData = {};
        let statusUpdateInterval = null;

        // STATE a√ßƒ±klamalarƒ±
        const STATE_MEANINGS = {
            1: 'IDLE',
            2: 'CABLE_DETECT',
            3: 'EV_CONNECTED',
            4: 'SARJA_HAZIR',
            5: 'SARJ_BASLADI',
            6: 'SARJ_DURAKLATILDI',
            7: 'SARJ_BITIR',
            8: 'FAULT_HARD'
        };

        // Initialize curl previews and status bar on page load
        document.addEventListener('DOMContentLoaded', async () => {
            cachedApiKey = await getApiKey();
            updateCurlPreview('POST', '/api/charge/start', 'body-/api/charge/start', 'curl-/api/charge/start');
            updateCurlPreview('POST', '/api/charge/stop', 'body-/api/charge/stop', 'curl-/api/charge/stop');
            updateCurlPreview('POST', '/api/maxcurrent', 'body-/api/maxcurrent', 'curl-/api/maxcurrent', true);
            
            // Start ESP32 status polling
            startStatusPolling();
        });

        async function startStatusPolling() {
            // ƒ∞lk g√ºncelleme
            await updateESP32Status();
            
            // Her 3 saniyede bir g√ºncelle (ESP32 5 saniyede bir g√∂nderiyor)
            statusUpdateInterval = setInterval(updateESP32Status, 3000);
        }

        async function updateESP32Status() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/status`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success && data.data) {
                    updateStatusBar(data.data);
                    document.getElementById('statusDot').classList.remove('offline');
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Status update error:', error);
                document.getElementById('statusDot').classList.add('offline');
                document.getElementById('lastUpdate').textContent = 'Baƒülantƒ± hatasƒ±';
            }
        }

        function updateStatusBar(data) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('tr-TR');
            
            // Son g√ºncelleme zamanƒ±
            document.getElementById('lastUpdate').textContent = `Son g√ºncelleme: ${timeStr}`;
            
            // STATE g√ºncelleme (renk deƒüi≈üimi ile)
            updateStatusItem('stateValue', data.STATE, STATE_MEANINGS[data.STATE] || 'UNKNOWN', 'statusState', `status-state-${data.STATE}`);
            
            // Diƒüer deƒüerler
            updateStatusItem('cpValue', data.CP, data.CP);
            updateStatusItem('ppValue', data.PP, data.PP);
            updateStatusItem('rlValue', data.RL, data.RL);
            updateStatusItem('lockValue', data.LOCK, data.LOCK);
            updateStatusItem('maxValue', data.MAX, data.MAX);
            updateStatusItem('authValue', data.AUTH, data.AUTH);
        }

        function updateStatusItem(elementId, newValue, displayValue, containerId = null, stateClass = null) {
            const element = document.getElementById(elementId);
            const container = containerId ? document.getElementById(containerId) : element.parentElement;
            
            if (!element) return;
            
            const oldValue = lastStatusData[elementId];
            const hasChanged = oldValue !== undefined && oldValue !== newValue;
            
            // Deƒüeri g√ºncelle
            element.textContent = displayValue;
            lastStatusData[elementId] = newValue;
            
            // STATE i√ßin renk sƒ±nƒ±fƒ±nƒ± g√ºncelle
            if (stateClass && container) {
                // Eski state sƒ±nƒ±flarƒ±nƒ± kaldƒ±r
                container.className = container.className.replace(/status-state-\d+/g, '');
                // Yeni state sƒ±nƒ±fƒ±nƒ± ekle
                container.classList.add('status-item', stateClass);
            }
            
            // Deƒüi≈üiklik varsa highlight animasyonu
            if (hasChanged && container) {
                container.classList.add('changed');
                setTimeout(() => {
                    container.classList.remove('changed');
                }, 600);
            }
        }

        // Sayfa kapatƒ±lƒ±rken polling'i durdur
        window.addEventListener('beforeunload', () => {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
        });

        function updateCurlPreviewDebounced(method, path, bodyElementId, curlElementId, isNumber = false) {
            /**
             * Debounced curl preview update - Performans optimizasyonu
             * Input deƒüi≈üikliklerinde 300ms bekle, sonra g√ºncelle
             */
            const key = `${method}-${path}`;
            if (curlPreviewTimeouts[key]) {
                clearTimeout(curlPreviewTimeouts[key]);
            }
            curlPreviewTimeouts[key] = setTimeout(() => {
                updateCurlPreview(method, path, bodyElementId, curlElementId, isNumber);
            }, 300);
        }

        async function updateCurlPreview(method, path, bodyElementId, curlElementId, isNumber = false) {
            const curlElement = document.getElementById(curlElementId);
            if (!curlElement) return;

            // Get API key
            if (!cachedApiKey) {
                cachedApiKey = await getApiKey();
            }

            // Prepare request body
            let requestBody = null;
            let requestBodyDisplay = null;
            
            if (bodyElementId) {
                const bodyElement = document.getElementById(bodyElementId);
                    if (isNumber) {
                        // For number input (maxcurrent)
                        const value = parseInt(bodyElement.value);
                        // Validate amperage
                        if (isNaN(value) || value < 6 || value > 32) {
                            curlElement.value = `# Invalid amperage: ${bodyElement.value}. Must be between 6 and 32.`;
                            return;
                        }
                        requestBody = { amperage: value };
                        requestBodyDisplay = JSON.stringify(requestBody, null, 2);
                } else {
                    // For textarea (JSON)
                    const text = bodyElement.value.trim();
                    if (text) {
                        try {
                            requestBody = JSON.parse(text);
                            requestBodyDisplay = JSON.stringify(requestBody, null, 2);
                        } catch (e) {
                            // Invalid JSON, use raw text
                            requestBodyDisplay = text;
                        }
                    } else {
                        requestBody = {};
                        requestBodyDisplay = '{}';
                    }
                }
            } else {
                requestBodyDisplay = 'null';
            }

            // Generate curl command
            const curlCommand = generateCurlCommand(method, path, cachedApiKey, requestBodyDisplay);
            curlElement.value = curlCommand;
        }

        async function testEndpoint(method, path, bodyElementId, isNumber = false) {
            const responseSection = document.getElementById(`response-${path}`);
            const button = event.target;
            const originalText = button.textContent;
            
            // Loading state
            button.disabled = true;
            button.innerHTML = originalText + '<span class="loading"></span>';
            
            // Hide previous response
            responseSection.classList.remove('show');
            
            try {
                // Prepare request body
                let requestBody = null;
                let requestBodyDisplay = null;
                
                if (bodyElementId) {
                    const bodyElement = document.getElementById(bodyElementId);
                    if (isNumber) {
                        // For number input (maxcurrent)
                        const value = parseInt(bodyElement.value);
                        requestBody = { amperage: value };
                        requestBodyDisplay = JSON.stringify(requestBody, null, 2);
                    } else {
                        // For textarea (JSON)
                        const text = bodyElement.value.trim();
                        if (text) {
                            try {
                                requestBody = JSON.parse(text);
                                requestBodyDisplay = JSON.stringify(requestBody, null, 2);
                            } catch (e) {
                                throw new Error(`Invalid JSON: ${e.message}`);
                            }
                        } else {
                            requestBody = {};
                            requestBodyDisplay = '{}';
                        }
                    }
                } else {
                    requestBodyDisplay = 'null';
                }

                // Prepare request options
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': await getApiKey() // Get API key from backend
                    }
                };

                if (requestBody) {
                    options.body = JSON.stringify(requestBody);
                }

                // Make request
                const startTime = Date.now();
                const response = await fetch(`${API_BASE_URL}${path}`, options);
                const endTime = Date.now();
                const responseTime = endTime - startTime;

                // Get response body
                const responseText = await response.text();
                let responseBody;
                try {
                    responseBody = JSON.parse(responseText);
                } catch (e) {
                    responseBody = responseText;
                }

                // Get API key for display
                const apiKey = await getApiKey();
                
                // Display response
                displayResponse(responseSection, {
                    method,
                    path,
                    requestBody: requestBodyDisplay,
                    apiKey: apiKey,
                    status: response.status,
                    statusText: response.statusText,
                    responseTime,
                    responseBody: typeof responseBody === 'string' ? responseBody : JSON.stringify(responseBody, null, 2)
                });

            } catch (error) {
                // Get API key for display
                const apiKey = await getApiKey();
                
                // User-friendly error messages
                let errorMessage = error.message || 'Unknown error occurred';
                let userFriendlyMessage = errorMessage;
                
                if (errorMessage.includes('Failed to fetch') || errorMessage.includes('NetworkError')) {
                    userFriendlyMessage = 'Network error: Could not connect to API server. Please check if the server is running.';
                } else if (errorMessage.includes('Invalid JSON')) {
                    userFriendlyMessage = `Invalid JSON format: ${errorMessage}`;
                } else if (errorMessage.includes('Invalid amperage')) {
                    userFriendlyMessage = errorMessage;
                }
                
                // Display error
                displayResponse(responseSection, {
                    method,
                    path,
                    requestBody: requestBodyDisplay || 'null',
                    apiKey: apiKey,
                    status: 'ERROR',
                    statusText: userFriendlyMessage,
                    responseTime: null,
                    responseBody: error.toString()
                });
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        async function getApiKey() {
            try {
                // Get API key from backend endpoint
                const response = await fetch(`${API_BASE_URL}/api/test/key`);
                const data = await response.json();
                return data.api_key || '';
            } catch (error) {
                console.error('Failed to get API key:', error);
                return '';
            }
        }

        function escapeShellString(str) {
            /**
             * Shell komutlarƒ± i√ßin g√ºvenli string escape fonksiyonu
             * T√ºm shell √∂zel karakterlerini escape eder
             */
            if (typeof str !== 'string') return '';
            return str
                .replace(/\\/g, '\\\\')  // Backslash'i √∂nce escape et
                .replace(/'/g, "'\\''")   // Single quote escape
                .replace(/[;&|`$(){}[\]<>]/g, '\\$&')  // Diƒüer shell √∂zel karakterler
                .replace(/\n/g, '\\n')    // Newline
                .replace(/\r/g, '\\r')    // Carriage return
                .replace(/\t/g, '\\t');   // Tab
        }

        function generateCurlCommand(method, path, apiKey, requestBody) {
            const url = `${API_BASE_URL}${path}`;
            let curlCmd = `curl -X ${method} "${url}"`;
            
            // Add headers
            curlCmd += ` \\\n  -H "Content-Type: application/json"`;
            curlCmd += ` \\\n  -H "X-API-Key: ${escapeShellString(apiKey)}"`;
            
            // Add body if exists
            if (requestBody && requestBody !== 'null' && requestBody.trim() !== '') {
                const bodyStr = typeof requestBody === 'string' ? requestBody : JSON.stringify(requestBody);
                // G√ºvenli shell escape
                const escapedBody = escapeShellString(bodyStr);
                curlCmd += ` \\\n  -d '${escapedBody}'`;
            }
            
            return curlCmd;
        }

        async function displayResponse(section, data) {
            const statusClass = data.status >= 200 && data.status < 300 ? 'success' : 
                               data.status === 'ERROR' ? 'error' : 'info';
            
            // Use provided API key or get it
            const apiKey = data.apiKey || await getApiKey();
            const curlCommand = generateCurlCommand(data.method, data.path, apiKey, data.requestBody);
            
            section.innerHTML = `
                <div class="response-header">
                    <h3>Response</h3>
                    <div>
                        <span class="status-badge ${statusClass}">${data.status} ${data.statusText || ''}</span>
                        ${data.responseTime ? `<span style="margin-left: 10px; color: #666; font-size: 0.85em;">${data.responseTime}ms</span>` : ''}
                    </div>
                </div>
                
                <div class="section-title">üíª cURL Command</div>
                <div class="request-display">${escapeHtml(curlCommand)}</div>
                
                <div class="section-title">üì§ Request</div>
                <div class="request-display">${escapeHtml(data.method)} ${escapeHtml(data.path)}
${data.requestBody && data.requestBody !== 'null' ? escapeHtml(data.requestBody) : 'No body'}</div>
                
                <div class="section-title">üì• Response</div>
                <div class="response-display">${escapeHtml(data.responseBody)}</div>
            `;
            
            section.classList.add('show');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

